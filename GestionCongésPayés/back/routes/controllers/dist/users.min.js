"use strict";require("../../config/db"),require("dotenv").config();var _require=require("../../models"),Users=_require.Users,_require2=require("../../models"),Holidays=_require2.Holidays,_require3=require("../../models"),Demandes=_require3.Demandes,_require4=require("../../models"),Types=_require4.Types,_require5=require("../../models"),Statuses=_require5.Statuses,express=require("express"),jwt=require("jsonwebtoken"),app=express(),refreshTokens=[];function generateAccessToken(e){return jwt.sign(e,process.env.ACCESS_TOKEN_SECRET,{expiresIn:"15m"})}function calculateCongesPayes(e){try{for(var r=(new Date).getMonth()-e.getMonth()-1+12*((new Date).getFullYear()-e.getFullYear()),n=new Date,t=n.getDate(),s=0,a=1;a<=t;a++){n.setDate(a);var u=n.getDay();0!=u&&6!=u&&(s+=1)}for(var o=e.getDate(),i=e.getFullYear(),c=e.getMonth()+1,d=new Date(i,c,0).getDate(),l=0,p=o;p<=d;p++){e.setDate(p);var f=e.getDay();0!=f&&6!=f&&(l+=1)}return parseFloat(2.5*r+2.5/21*(s+l)).toFixed(1)}catch(e){res.send(e)}}function updateHoliday(e,r){try{var n=e.role;if(2==n||3==n){var t=e.firstWorkingDay,s=new Date(new Date(t).setMonth(new Date(t).getMonth()+6));if(new Date>=s){var a=calculateCongesPayes(t),u=r.holidaysTaken;return{holidaysAvailable:a-u,holidaysTaken:u}}}}catch(e){res.send(e)}}exports.createUser=function(r,u){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=r.body,e.next=4,regeneratorRuntime.awrap(Users.create(n).then(function(e){u.json(e);var r=e.id,n=e.role,t=e.firstWorkingDay;if(2==n||3==n){var s=new Date(new Date(t).setMonth(new Date(t).getMonth()+6)),a={UserId:[r],holidaysAvailable:new Date>=s?calculateCongesPayes(t):0,holidaysTaken:0};Holidays.create(a)}}));case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),u.send(e.t0);case 9:case"end":return e.stop()}},null,null,[[0,6]])},exports.getAll=function(e,r){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Users.findAll({include:[Demandes,Holidays]}));case 3:n=e.sent,r.json(n),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),r.send(e.t0);case 10:case"end":return e.stop()}},null,null,[[0,7]])},exports.getUserById=function(r,n){var t,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.params.id,e.next=4,regeneratorRuntime.awrap(Users.findByPk(t,{include:[{model:Demandes,include:[Types,Statuses]},Holidays]}));case 4:s=e.sent,n.json(s),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),n.send(e.t0);case 11:case"end":return e.stop()}},null,null,[[0,8]])},exports.userLogin=function(r,n){var t,s,a,u,o,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.body.userName,s=r.body.password,e.next=5,regeneratorRuntime.awrap(Users.findOne({where:{userName:[t],password:[s]},include:[{model:Demandes,include:[Types,Statuses]},Holidays]}));case 5:(a=e.sent)?(u={name:t,role:a.role},o=generateAccessToken(u),i=jwt.sign(u,process.env.REFRESH_TOKEN_SECRET),n.json({user:a,accesstoken:o,refreshtoken:i})):n.json(null),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),n.send(e.t0);case 12:case"end":return e.stop()}},null,null,[[0,9]])},exports.userToken=function(r,n){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,null==(t=r.body.token))return e.abrupt("return",n.sendStatus(401));e.next=4;break;case 4:if(refreshTokens.includes(t)){e.next=6;break}return e.abrupt("return",n.sendStatus(403));case 6:jwt.verify(t,process.env.REFRESH_TOKEN_SECRET,function(e,r){if(e)return n.sendStatus(403)}),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),n.send(e.t0);case 12:case"end":return e.stop()}},null,null,[[0,9]])},exports.userLogOut=function(r,n){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:refreshTokens=refreshTokens.filter(function(e){return e!==r.body.token}),n.sendStatus(204);case 2:case"end":return e.stop()}})},exports.deleteUserById=function(r,n){var t,s,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.params.id,e.next=4,regeneratorRuntime.awrap(Holidays.findOne({where:{UserId:[t]}}));case 4:return s=e.sent,e.next=7,regeneratorRuntime.awrap(Demandes.findAll({where:{UserId:[t]}}));case 7:if(a=e.sent,s)return e.next=11,regeneratorRuntime.awrap(Holidays.destroy({where:{UserId:[t]}}));e.next=11;break;case 11:return a&&a.forEach(function(e){Demandes.destroy({where:{UserId:[t]}})}),e.next=14,regeneratorRuntime.awrap(Users.destroy({where:{id:[t]}}));case 14:n.json("user and user's holidays are deleted"),e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),n.send(e.t0);case 20:case"end":return e.stop()}},null,null,[[0,17]])},exports.updateUser=function(r,a){var u,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,u=r.body.id,e.next=4,regeneratorRuntime.awrap(Users.findByPk(u));case 4:if(e.sent)return delete(n=r.body).id,e.next=10,regeneratorRuntime.awrap(Users.update(n,{where:{id:[u]},returning:!0}).then(function(){var r,n,t,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Users.findByPk(u));case 2:return r=e.sent,e.next=5,regeneratorRuntime.awrap(Holidays.findByPk(u));case 5:return n=e.sent,(t=updateHoliday(r,n))&&Holidays.update(t,{where:{UserId:[u]}}),e.next=10,regeneratorRuntime.awrap(Users.findByPk(u,{include:[Holidays]}));case 10:s=e.sent,a.json(s);case 12:case"end":return e.stop()}})}));e.next=12;break;case 10:e.next=13;break;case 12:a.json("user doesn't exist");case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(0),a.send(e.t0);case 18:case"end":return e.stop()}},null,null,[[0,15]])},exports.updateUserHoliday=function(r,n){var t,s,a,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.params.idUser,e.next=4,regeneratorRuntime.awrap(Users.findByPk(t));case 4:return s=e.sent,e.next=7,regeneratorRuntime.awrap(Holidays.findOne({where:{UserId:[t]}}));case 7:a=e.sent,(u=updateHoliday(s,a))&&Holidays.update(u,{where:{UserId:[t]}}),n.json(u),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),n.send(e.t0);case 16:case"end":return e.stop()}},null,null,[[0,13]])};
//# sourceMappingURL=users.min.js.map
